# This is a basic workflow to help you get started with Actions

name: Salesfoce Demo

# Controls when the workflow will run
on:
  # Triggers the workflow on push events but only for the main branch
  push:
    branches: [ main ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "check"
  # check:
  #   # The type of runner that the job will run on
  #   runs-on: ubuntu-latest
  #   # Steps represent a sequence of tasks that will be executed as part of the job
  #   steps:
  #     # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
  #     - uses: actions/checkout@v2

  #     # Runs a single command using the runners shell
  #     - name: Run a one-line script
  #       run: echo Hello, world by KRATI!

  #     # Runs a set of commands using the runners shell
  #     - name: Run a multi-line script
  #       run: |
  #         echo Add other actions to build,
  #         echo test, and deploy your project.

  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2              
      - name: Write the token into a file
        run: 'echo ${{ secrets.SF_DEVHUB_AUTH_URL}} > token.txt'
      - name: Install Salesforce CLI
        run: |
          wget https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz
          mkdir sfdx-cli
          tar xJf sfdx-linux-amd64.tar.xz -C sfdx-cli --strip-components 1
          ./sfdx-cli/install
      - name: Auth with the DevHub
        run: 'sfdx force:auth:sfdxurl:store -f token.txt -a DevHub -d'
      - name: Create scratch org
        run: 'sfdx force:org:create -f config/project-scratch-def.json -a my-scratch'
      - name: Push source
        run: 'sfdx force:source:push -u my-scratch'
      - name: List orgs
        run: 'sfdx force:org:list'
      - name: Run tests
        run: 'sfdx force:apex:test:run -u my-scratch --resultformat human'
      - name: Delete scratch org
        run: 'sfdx force:org:delete -u my-scratch --noprompt'        

  # deploy:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: actions/setup-node@v1 
  #       with:
  #         node-version: '>=14'
  #         check-latest: true

  #     - name: Install Salesfoce CLI 
  #       run: |
  #         npm install sfdx-cli 
  #         node_modules/sfdx-cli/bin/run --version
  #         node_modules/sfdx-cli/bin/run plugins --core 

  #     - name: 'Polpulate auth file with sfdx_auth_url secret'
  #       shell: bash
  #       env:
  #        DEVHUB_URL: ${{ secrets.SF_DEVHUB_AUTH_URL }}
  #       run: |
  #         'echo "Value of auth url repo variable is -" '
  #         'echo $DEVHUB_URL'
  #         'echo "Stroring variable value in a file ....."'
  #         'echo $DEVHUB_URL > SF_DEV_URL'


  #     - name: 'Authenticate against dev hub url'
  #       run: node_modules/sfdx-cli/bin/run force:auth:sfdxurl:store -f SF_DEV_URL -s -a DEVHUB

  #     - name: 'Push changes to dev hub'
  #       run: node_modules/sfdx-cli/bin/run force:source:deploy -p force-app -u DEVHUB --json 

  #     - name: 'Echo success msg'
  #       shell: bash
  #       run: 'echo Changes deployed successfully to dev hub org'



